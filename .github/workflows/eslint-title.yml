name: üö® ESLint Title Manager

on:
  pull_request:
    branches:
      - master
      - main
    types: [opened, synchronize, reopened]
  workflow_run:
    workflows: ["üõ†Ô∏è Code Quality Check"]
    types: [completed]

permissions:
  pull-requests: write
  contents: read

jobs:
  eslint-title-update:
    name: üìù Update PR Title Based on ESLint
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.event == 'pull_request'
    steps:
      - name: üîç Get PR Number
        id: get-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const { data: run } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            
            // Get PR from head SHA
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${run.head_branch}`,
              state: 'open'
            });
            
            if (prs.length === 0) {
              console.log('No open PR found for this workflow run');
              return;
            }
            
            const pr = prs[0];
            const conclusion = context.payload.workflow_run.conclusion;
            const currentTitle = pr.title;
            const PREFIX = 'ESLint FAILED - ';
            
            console.log(`PR #${pr.number}: "${currentTitle}"`);
            console.log(`ESLint conclusion: ${conclusion}`);
            
            if (conclusion === 'failure') {
              // Add prefix if not already present
              if (!currentTitle.startsWith(PREFIX)) {
                const newTitle = PREFIX + currentTitle;
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  title: newTitle
                });
                console.log(`Updated title to: ${newTitle}`);
              }
            } else if (conclusion === 'success') {
              // Remove prefix if present
              if (currentTitle.startsWith(PREFIX)) {
                const newTitle = currentTitle.replace(PREFIX, '');
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  title: newTitle
                });
                console.log(`Updated title to: ${newTitle}`);
              }
            }
